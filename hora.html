<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="hora.css" />
    <title>Agendamento de Corte</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"
    />
  </head>
  <body>
    <section class="agendamento">
      <div class="header">
        <img src="https://placehold.co/100x100" alt="" />
      </div>
      <div class="abas">
        <button id="showAppointmentFormBtn" class="button-clicked">
          Agendar
        </button>
        <button id="showDeleteFormBtn">Excluir</button>
      </div>

      <div class="formulario">
        <h2>Faça sua Reserva</h2>
        <div class="opcoes inputGroup">
          <input
            type="text"
            id="name"
            maxlength="20"
            onkeypress="preventNonAlphabetic(event)"
            required
            autocomplete="off"
          />
          <label for="name"><i class="fa-solid fa-user"></i>Nome</label>
        </div>
        <!-- <div class="opcoes">
          <label for="name">Nome:</label>
          <input
            type="text"
            id="name"
            maxlength="20"
            onkeypress="preventNonAlphabetic(event)"
            required
          />
        </div> -->

        <div class="opcoes inputGroup">
          <input type="email" id="email" maxlength="35" required />
          <label for="email"><i class="fa-solid fa-envelope"></i>E-mail</label>
        </div>
        <!-- <div class="opcoes">
          <label for="email">E-mail:</label>
          <input type="email" id="email" maxlength="35" required />
        </div> -->

        <div class="opcoes inputGroup">
          <input
            type="text"
            id="phone"
            maxlength="9"
            oninput="validatePhone()"
            required
          />
          <label for="phone"><i class="fa-solid fa-phone"></i>Telefone</label>
        </div>

        <!-- <div class="opcoes">
          <label for="phone">Telefone:</label>
          <input
            type="text"
            id="phone"
            maxlength="9"
            oninput="validatePhone()"
            required
          />
        </div> -->

        <div class="opcoes">
          <!-- <label for="barber">Barbeiro:</label> -->
          <select id="barber" required>
            <option value="">Escolha o Barbeiro</option>
            <option value="barbeiro1">Barbeiro 1</option>
            <option value="barbeiro2">Barbeiro 2</option>
            <option value="barbeiro3">Barbeiro 3</option>
          </select>
        </div>

        <div class="opcoes">
          <!-- <label for="style">Estilo de Corte:</label> -->
          <select id="style" required>
            <option value="">Escolha o Estilo de Corte</option>
            <option value="normal">Corte Normal (30min)</option>
            <option value="barba">Corte + Barba (1h)</option>
            <option value="pintura">Pintura (2h)</option>
          </select>
        </div>

        <div class="opcoes">
          <label for="date">Dia:</label>
          <div id="date" class="date-container"></div>
        </div>

        <div class="opcoes">
          <label for="time">Horário:</label>
          <div id="time" class="time-container"></div>
        </div>

        <div class="opcoes">
          <button id="submit-button" class="btn"><span>Agendar</span></button>
        </div>

        <div id="successModal" class="modal">
          <div class="modal-content">
            <div id="modalMessage" class="modal-message"></div>
            <button onclick="closeModal()">OK</button>
          </div>
        </div>
      </div>

      <div class="loading" id="loading">
        <div class="loader" id="loader"></div>
      </div>
      <ul class="notification-container" id="notification-container">
        <li class="notification-item success">
          <div class="notification-content">
            <div class="notification-icon">
              <svg aria-hidden="true" fill="none" viewBox="0 0 24 24">
                <path
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8.5 11.5 11 14l4-4m6 2a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
                ></path>
              </svg>
            </div>
            <div class="notification-text">Everything went perfectly!</div>
          </div>
          <div class="notification-icon notification-close">
            <svg aria-hidden="true" fill="none" viewBox="0 0 24 24">
              <path
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18 17.94 6M18 18 6.06 6"
              ></path>
            </svg>
          </div>
          <div class="notification-progress-bar"></div>
        </li>
        <li class="notification-item warning">
          <div class="notification-content">
            <div class="notification-icon">
              <svg aria-hidden="true" fill="none" viewBox="0 0 24 24">
                <path
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 13V8m0 8h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
                ></path>
              </svg>
            </div>
            <div class="notification-text">Proceed with caution.</div>
          </div>
          <div class="notification-icon notification-close">
            <svg aria-hidden="true" fill="none" viewBox="0 0 24 24">
              <path
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18 17.94 6M18 18 6.06 6"
              ></path>
            </svg>
          </div>
          <div class="notification-progress-bar"></div>
        </li>
        <li class="notification-item error">
          <div class="notification-content">
            <div class="notification-icon">
              <svg aria-hidden="true" fill="none" viewBox="0 0 24 24">
                <path
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="m15 9-6 6m0-6 6 6m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
                ></path>
              </svg>
            </div>
            <div class="notification-text">An issue occurred.</div>
          </div>
          <div class="notification-icon notification-close">
            <svg aria-hidden="true" fill="none" viewBox="0 0 24 24">
              <path
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18 17.94 6M18 18 6.06 6"
              ></path>
            </svg>
          </div>
          <div class="notification-progress-bar"></div>
        </li>
      </ul>
      <form id="deleteAppointmentForm" class="delete-form">
        <h2>Delete sua Reserva</h2>
        <div class="opcoes inputGroup">
          <input
            type="text"
            id="delete-phone"
            maxlength="9"
            oninput="validatePhone()"
            required
          />
          <label for="phone"><i class="fa-solid fa-phone"></i>Telefone</label>
        </div>

        <div class="opcoes">
          <select id="delete-barber" required>
            <option value="">Escolha o Barbeiro</option>
            <option value="barbeiro1">Barbeiro 1</option>
            <option value="barbeiro2">Barbeiro 2</option>
            <option value="barbeiro3">Barbeiro 3</option>
          </select>
        </div>

        <div class="opcoes">
          <select id="delete-style" required>
            <option value="">Escolha o Estilo de Corte</option>
            <option value="normal">Corte Normal (30min)</option>
            <option value="barba">Corte + Barba (1h)</option>
            <option value="pintura">Pintura (2h)</option>
          </select>
        </div>

        <div class="opcoes delete-appointment">
          <label for="date">Dia:</label>
          <div id="delete-date" class="date-container"></div>
        </div>

        <div class="opcoes delete-appointment">
          <label for="time">Horário:</label>
          <div id="delete-time" class="time-container"></div>
        </div>
        <div class="opcoes">
          <button type="submit" class="delete-btn">Deletar Agendamento</button>
          <!--  <div class="delete-loading" id="delete-loading">
            <div class="loader" id="loader"></div>
          </div> -->
        </div>

        <!-- <ul class="notification-container" id="notification-container-delete">
          <li class="notification-item success">
            <div class="notification-content">
              <div class="notification-icon">
                <svg aria-hidden="true" fill="none" viewBox="0 0 24 24">
                  <path
                    stroke="currentColor"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8.5 11.5 11 14l4-4m6 2a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
                  ></path>
                </svg>
              </div>
              <div class="notification-text">Everything went perfectly!</div>
            </div>
            <div class="notification-icon notification-close">
              <svg aria-hidden="true" fill="none" viewBox="0 0 24 24">
                <path
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18 17.94 6M18 18 6.06 6"
                ></path>
              </svg>
            </div>
            <div class="notification-progress-bar"></div>
          </li>
          <li class="notification-item warning">
            <div class="notification-content">
              <div class="notification-icon">
                <svg aria-hidden="true" fill="none" viewBox="0 0 24 24">
                  <path
                    stroke="currentColor"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 13V8m0 8h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
                  ></path>
                </svg>
              </div>
              <div class="notification-text">Proceed with caution.</div>
            </div>
            <div class="notification-icon notification-close">
              <svg aria-hidden="true" fill="none" viewBox="0 0 24 24">
                <path
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18 17.94 6M18 18 6.06 6"
                ></path>
              </svg>
            </div>
            <div class="notification-progress-bar"></div>
          </li>
          <li class="notification-item error">
            <div class="notification-content">
              <div class="notification-icon">
                <svg aria-hidden="true" fill="none" viewBox="0 0 24 24">
                  <path
                    stroke="currentColor"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="m15 9-6 6m0-6 6 6m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
                  ></path>
                </svg>
              </div>
              <div class="notification-text">An issue occurred.</div>
            </div>
            <div class="notification-icon notification-close">
              <svg aria-hidden="true" fill="none" viewBox="0 0 24 24">
                <path
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18 17.94 6M18 18 6.06 6"
                ></path>
              </svg>
            </div>
            <div class="notification-progress-bar"></div>
          </li>
        </ul> -->

        <div id="delete-successModal" class="modal">
          <div class="modal-content">
            <div id="delete-modalMessage" class="modal-message"></div>
            <button onclick="deleteCloseModal()">OK</button>
          </div>
        </div>
      </form>
    </section>

    <!-- <section class="delete-appointment agendamento"></section> -->

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const barberSelect = document.getElementById("barber");
        const styleSelect = document.getElementById("style");
        const dateContainer = document.getElementById("date");
        const timeContainer = document.getElementById("time");

        function clearSelection(container) {
          container.innerHTML = "";
        }

        function resetTimeSelection() {
          timeContainer.innerHTML = ""; // Remove os botões de horário
        }

        function resetDaySelection() {
          const selectedDay = dateContainer.querySelector(".selected");
          if (selectedDay) {
            selectedDay.classList.remove("selected");
          }
        }

        barberSelect.addEventListener("change", function () {
          styleSelect.value = ""; // Volta para a opção inicial
          resetDaySelection();
          resetTimeSelection();
        });

        styleSelect.addEventListener("change", function () {
          resetDaySelection();
          resetTimeSelection();
        });
      });

      const showAppointmentFormBtn = document.getElementById(
        "showAppointmentFormBtn"
      );
      const showDeleteFormBtn = document.getElementById("showDeleteFormBtn");
      const formulario = document.querySelector(".formulario");
      const deleteForm = document.querySelector(".delete-form");

      // Garante que o formulário de reserva já esteja visível ao carregar a página
      formulario.classList.add("active");

      showAppointmentFormBtn.addEventListener("click", function () {
        deleteForm.classList.remove("active");
        formulario.classList.add("active");
        this.classList.add("button-clicked");
        showDeleteFormBtn.classList.remove("button-clicked");
      });

      showDeleteFormBtn.addEventListener("click", function () {
        formulario.classList.remove("active");
        deleteForm.classList.add("active");
        this.classList.add("button-clicked");
        showAppointmentFormBtn.classList.remove("button-clicked");
      });

      function renderDayButtons(parentElement) {
        for (let i = 1; i < 14; i++) {
          const currentDate = new Date();
          currentDate.setDate(currentDate.getDate() + i);

          // Verifica se o dia atual não é sábado (6) nem domingo (0)
          if (currentDate.getDay() !== 0 && currentDate.getDay() !== 6) {
            const button = document.createElement("button");
            button.textContent = formatDateUserFriendly(currentDate);
            button.setAttribute("data-date", formatDate(currentDate));

            // Modifica o evento onClick para impedir a submissão do formulário
            button.onclick = function (event) {
              event.preventDefault(); // Impede o comportamento padrão do formulário
              const buttons = parentElement.getElementsByTagName("button");
              for (const otherButton of buttons) {
                otherButton.classList.remove("selected");
              }
              this.classList.add("selected");

              const selectedDate = new Date(this.getAttribute("data-date"));

              // Adicione qualquer outra lógica necessária aqui
            };

            parentElement.appendChild(button);
          }
        }
      }

      function getAvailable(style) {
        const halfTimes = [
          "08:00-08:30",
          "08:30-09:00",
          "09:00-09:30",
          "09:30-10:00",
          "10:00-10:30",
          "10:30-11:00",
          "11:00-11:30",
          "11:30-12:00",
          "12:00-12:30",
          "12:30-13:00",
          "15:00-15:30",
          "15:30-16:00",
          "16:00-16:30",
          "16:30-17:00",
          "17:00-17:30",
          "17:30-18:00",
          "18:00-18:30",
          "18:30-19:00",
        ];
        const oneTimes = [
          "08:00-09:00",
          "09:00-10:00",
          "10:00-11:00",
          "11:00-12:00",
          "12:00-13:00",
          "15:00-16:00",
          "16:00-17:00",
          "17:00-18:00",
          "18:00-19:00",
        ];
        const twoTimes = [
          "08:00-10:00",
          "10:00-12:00",
          "14:00-16:00",
          "16:00-18:00",
          "18:00-20:00",
          "20:00-22:00",
        ];
        return style === "barba"
          ? oneTimes
          : style === "normal"
          ? halfTimes
          : style === "pintura"
          ? twoTimes
          : [];
      }

      function renderTimeButtons(parentElement, style) {
        parentElement.innerHTML = "";

        const availableTimes = getAvailable(style);

        // Adiciona um botão para cada horário disponível
        availableTimes.forEach((time) => {
          const button = document.createElement("button");
          button.textContent = time;
          button.setAttribute("data-time", time);
          button.onclick = function (event) {
            event.preventDefault(); // Impede o comportamento padrão do botão
            const buttons = parentElement.getElementsByTagName("button");
            for (const otherButton of buttons) {
              otherButton.classList.remove("selected");
            }
            this.classList.add("selected");
          };
          button.classList.add("delete-appointment-time"); // Adiciona a classe para diferenciar os botões de horário de exclusão
          parentElement.appendChild(button);
        });
      }

      window.onload = function () {
        const deleteFormDateContainer = document.querySelector(
          ".delete-appointment #delete-date"
        );
        const deleteFormTimeContainer = document.querySelector(
          ".delete-appointment #delete-time"
        );

        renderDayButtons(deleteFormDateContainer);

        // Renderiza os botões de horário ao carregar a página com o estilo 'normal'
        renderTimeButtons(deleteFormTimeContainer, "");
      };

      document.getElementById("delete-style").onchange = function () {
        const parentElement = document.querySelector(
          ".delete-appointment #delete-time"
        );
        const style = this.value;

        // Chama a função renderTimeButtons com o elemento pai e o estilo selecionado
        renderTimeButtons(parentElement, style);
      };

      /* --------- */

      document
        .querySelector(".delete-btn")
        .addEventListener("click", async function (event) {
          showLoading();
          event.preventDefault();

          const clientId = "1";
          const calendarId =
            "f4392d051f66e3988107791ea88f04fe83f4641849fe2ffe8773c08e32bebaa6@group.calendar.google.com";
          const phone = document.getElementById("delete-phone").value;
          const selectedBarber = document.getElementById("delete-barber").value;

          const selectedDateButton = document.querySelector(
            "#delete-date button.selected"
          );

          const selectedStyle = document.getElementById("delete-style").value;
          const selectedTime = document.querySelector(
            "#delete-time button.selected"
          );

          const barberColorId = mapBarberToColor(selectedBarber);

          if (
            !phone &&
            !selectedBarber &&
            !selectedStyle &&
            !selectedDateButton &&
            !selectedTime
          ) {
            displayAlert(
              "warning",
              "Por favor, preencha todos os campos obrigatórios."
            );
            hideLoading();
            return;
          }

          if (!phone) {
            displayAlert("warning", "Por favor, digite um número de telefone.");
            hideLoading();
            return;
          }

          if (!selectedBarber) {
            displayAlert("warning", "Por favor, escolha um barbeiro.");
            hideLoading();
            return;
          }

          if (!selectedStyle) {
            displayAlert("warning", "Por favor, escolha um estilo de corte.");
            hideLoading();
            return;
          }

          if (!selectedDateButton) {
            displayAlert("warning", "Por favor, selecione um dia.");
            hideLoading();
            return;
          }

          if (!selectedTime) {
            displayAlert("warning", "Por favor, selecione um horário.");
            hideLoading();
            return;
          }

          const selectedDate = new Date(
            selectedDateButton.getAttribute("data-date")
          );

          const selectedTimeValue = selectedTime.getAttribute("data-time");
          const [entry, exit] = selectedTimeValue.split("-");
          const entryDate = new Date(selectedDate);
          entryDate.setUTCHours(
            Number(entry.split(":")[0]),
            Number(entry.split(":")[1]),
            0,
            0,
            0
          );
          const exitDate = new Date(selectedDate);
          exitDate.setUTCHours(
            Number(exit.split(":")[0]),
            Number(exit.split(":")[1]),
            0,
            0,
            0
          );
          const dateTimeStart = entryDate.toISOString();
          const dateTimeEnd = exitDate.toISOString();

          try {
            const response = await fetch(
              "https://google-agenda.onrender.com/deleteAppointment",
              {
                method: "DELETE",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  clientId,
                  clientPhone: phone,
                  calendarId:
                    "f4392d051f66e3988107791ea88f04fe83f4641849fe2ffe8773c08e32bebaa6@group.calendar.google.com",
                  barberColorId: barberColorId,
                  dateTimeStart: dateTimeStart, // Já está em UTC+0
                  dateTimeEnd: dateTimeEnd, // Já está em UTC+0
                }),
              }
            );

            if (response.ok) {
              const styleLabel =
                selectedStyle === "normal"
                  ? "Corte Normal (30min)"
                  : selectedStyle === "barba"
                  ? "Corte + Barba (1h)"
                  : selectedStyle === "pintura"
                  ? "pintura (2h)"
                  : "";
              const formattedDate = formatDateUserFriendly(
                new Date(exitDate.getTime())
              );
              const successMessage = `Compromisso apagado com sucesso!\n\nTelefone: ${phone}\nBarbeiro: ${selectedBarber}\nEstilo: ${styleLabel}\nData: ${formattedDate}\nHorário: ${selectedTimeValue}`;
              deleteModal(successMessage);
              displayAlert("success", "Compromisso apagado com sucesso.");
            } else {
              /* const errorText = await response.text();
            alert('Error: ' + errorText); */
              displayAlert("error", "Erro ao enviar a solicitação.");
            }
          } catch (error) {
            /* console.error('Error deleting appointment:', error); */
            displayAlert("error", "Erro ao enviar a solicitação.");
          } finally {
            hideLoading(); // Exibe o loader
            event.preventDefault();
          }
        });

      function deleteModal(message) {
        const modalMessage = document.getElementById("delete-modalMessage");
        const lines = message.split("\n");
        modalMessage.innerHTML = `<h2>${lines[0]}</h2>`;
        for (let i = 1; i < lines.length; i++) {
          const indexOfColon = lines[i].indexOf(":");
          if (indexOfColon !== -1) {
            const label = lines[i].substring(0, indexOfColon + 1);
            let value = lines[i].substring(indexOfColon + 1).trim();

            // Adiciona espaçamento antes de "Nome:", "Telefone:", etc.
            if (
              label === "Nome:" ||
              label === "Telefone:" ||
              label === "E-mail:"
            ) {
              value = `<span style="margin-right: 5px;">${value}</span>`;
            }

            modalMessage.innerHTML += `<p><strong>${label}</strong> ${value}</p>`;
          } else {
            modalMessage.innerHTML += `<p>${lines[i]}</p>`;
          }
        }
        document.getElementById("delete-successModal").style.display = "block";
      }

      function deleteCloseModal() {
        document.getElementById("delete-successModal").style.display = "none";
      }

      function deleteDisplayAlert(type, message) {
        const notificationContainer = document.getElementById(
          "notification-container-delete"
        ); // Certifique-se de ter um elemento com esse ID no HTML

        if (!notificationContainer) {
          console.error("Elemento #notification-container não encontrado.");
          return;
        }

        // Criar o elemento da notificação
        const notification = document.createElement("li");
        notification.className = `notification-item ${type}`;

        notification.innerHTML = `
        <div class="notification-content">
            <div class="notification-icon">
                ${getNotificationIcon(type)}
            </div>
            <div class="notification-text">${message}</div>
        </div>
        <div class="notification-icon notification-close">
            <svg aria-hidden="true" fill="none" viewBox="0 0 24 24">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18 17.94 6M18 18 6.06 6"></path>
            </svg>
        </div>
        <div class="notification-progress-bar"></div>
    `;

        // Adiciona a notificação ao container
        notificationContainer.appendChild(notification);

        // Remove a notificação após um tempo
        setTimeout(() => {
          notification.remove();
        }, 5000);

        // Permite fechar manualmente
        notification.querySelector(".notification-close").onclick = () =>
          notification.remove();
      }

      /* --- */

      function preventNonAlphabetic(event) {
        const keyCode = event.keyCode ? event.keyCode : event.which;
        // Aceita letras de A a Z (maiúsculas e minúsculas) e espaço (código 32)
        if (
          (keyCode < 65 || keyCode > 90) &&
          (keyCode < 97 || keyCode > 122) &&
          keyCode !== 32
        ) {
          event.preventDefault();
        }
      }

      function validatePhone() {
        var phoneInput = document.getElementById("phone");
        phoneInput.value = phoneInput.value.replace(/[^0-9]/g, "");
      }

      function formatDateUserFriendly(date) {
        const options = {
          weekday: "long",
          year: "numeric",
          month: "numeric",
          day: "numeric",
        };
        return date.toLocaleDateString("pt-BR", options);
      }

      function formatDate(date) {
        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(
          2,
          "0"
        )}-${String(date.getDate()).padStart(2, "0")}`;
      }

      function mapBarberToColor(barber) {
        return barber === "barbeiro1"
          ? "6"
          : barber === "barbeiro2"
          ? "7"
          : barber === "barbeiro3"
          ? "5"
          : "";
      }

      function getAvailableTimes(date, style) {
        const halfTimes = [
          "08:00-08:30",
          "08:30-09:00",
          "09:00-09:30",
          "09:30-10:00",
          "10:00-10:30",
          "10:30-11:00",
          "11:00-11:30",
          "11:30-12:00",
          "12:00-12:30",
          "12:30-13:00",
          "15:00-15:30",
          "15:30-16:00",
          "16:00-16:30",
          "16:30-17:00",
          "17:00-17:30",
          "17:30-18:00",
          "18:00-18:30",
          "18:30-19:00",
        ];
        const oneTimes = [
          "08:00-09:00",
          "09:00-10:00",
          "10:00-11:00",
          "11:00-12:00",
          "12:00-13:00",
          "15:00-16:00",
          "16:00-17:00",
          "17:00-18:00",
          "18:00-19:00",
        ];
        const twoTimes = [
          "08:00-10:00",
          "10:00-12:00",
          "14:00-16:00",
          "16:00-18:00",
          "18:00-20:00",
          "20:00-22:00",
        ];
        return style === "barba"
          ? oneTimes
          : style === "normal"
          ? halfTimes
          : style === "pintura"
          ? twoTimes
          : [];
      }

      function updateTimeButtons(selectedDate) {
        const timeContainer = document.getElementById("time");
        const availableTimes = getAvailableTimes(
          selectedDate,
          document.getElementById("style").value
        );

        // Verifica se todos os campos obrigatórios estão preenchidos
        if (!areFieldsFilled()) {
          timeContainer.innerHTML = ""; // Limpa os botões de horário
          return;
        }

        timeContainer.innerHTML = ""; // Limpa os botões de horário

        // Adiciona um botão para cada horário disponível
        availableTimes.forEach((time) => {
          const button = document.createElement("button");
          button.textContent = time;
          button.setAttribute("data-time", time);
          button.onclick = handleTimeButtonClick;
          timeContainer.appendChild(button);
        });
      }

      function handleTimeButtonClick(event) {
        const selectedTime = event.target.getAttribute("data-time");
        const timeButtons = document.querySelectorAll("#time button");
        timeButtons.forEach((button) => button.classList.remove("selected"));
        event.target.classList.add("selected");
      }

      const dateContainer = document.getElementById("date");

      for (let i = 1; i <= 14; i++) {
        const currentDate = new Date();
        currentDate.setDate(currentDate.getDate() + i);

        // Exclui sábados (6) e domingos (0)
        if (currentDate.getDay() !== 0 && currentDate.getDay() !== 6) {
          const button = document.createElement("button");
          button.textContent = formatDateUserFriendly(currentDate);
          button.setAttribute("data-date", formatDate(currentDate));

          // Adiciona o evento onClick diretamente no botão
          button.onclick = function () {
            const buttons = dateContainer.getElementsByTagName("button");
            for (const otherButton of buttons) {
              otherButton.classList.remove("selected");
            }
            this.classList.add("selected");

            const selectedDate = new Date(this.getAttribute("data-date"));
            updateTimeButtons(selectedDate);
          };

          dateContainer.appendChild(button);
        }
      }

      function formatDateToUTC(date) {
        const formattedDate = new Date(date);
        const offset = formattedDate.getTimezoneOffset(); // Obtém o offset em minutos
        formattedDate.setMinutes(formattedDate.getMinutes() + offset); // Ajusta para UTC+0
        return formattedDate.toISOString().slice(0, 19) + "Z"; // Retorna a data no formato UTC+0
      }

      async function checkAvailabilityAndUpdateInterface(
        startTime,
        endTime,
        timeType
      ) {
        const loader = document.getElementById("loading");
        loader.style.display = "block"; // Exibe o loader

        try {
          const selectedBarber = document.getElementById("barber").value;
          const barberColorId = mapBarberToColor(selectedBarber);
          const phone = document.getElementById("phone").value;

          const response = await fetch(
            "https://google-agenda.onrender.com/check-availability",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                clientPhone: phone,
                calendarId:
                  "f4392d051f66e3988107791ea88f04fe83f4641849fe2ffe8773c08e32bebaa6@group.calendar.google.com",
                barberColorId: barberColorId,
                start: startTime, // Já está em UTC+0
                end: endTime, // Já está em UTC+0
                timeType: timeType,
              }),
            }
          );

          if (response.ok) {
            const occupiedTimes = await response.json();
            updateOccupiedTimes(occupiedTimes);
            console.log(occupiedTimes);
          } else {
            const error = await response.json();
            clearAvailableTimes();
            displayAlert("error", error.error);
          }
        } catch (error) {
          console.error(error);
          clearAvailableTimes(); // Limpa os horários disponíveis em caso de erro de conexão
          displayAlert("error", "Erro ao verificar disponibilidade.");
        } finally {
          loader.style.display = "none"; // Oculta o loader
        }
      }

      function clearAvailableTimes() {
        const timeContainer = document.getElementById("time"); // Substitua pelo ID correto do container de horários
        if (timeContainer) {
          timeContainer.innerHTML = ""; // Remove todos os horários exibidos
        }
      }

      function showLoading() {
        document.getElementById("loading").style.display = "block";
      }

      function hideLoading() {
        document.getElementById("loading").style.display = "none";
      }

      /* MARCAÇÃO EM UTC+0 */
      document.getElementById("submit-button").onclick = async function () {
        showLoading(); // Exibe o loader ao clicar no botão

        const clientId = "1";
        const clientMailStore = "patrickalvesgon@gmail.com";
        const calendarId =
          "f4392d051f66e3988107791ea88f04fe83f4641849fe2ffe8773c08e32bebaa6@group.calendar.google.com";
        const name = document.getElementById("name").value;
        const email = document.getElementById("email").value;
        const phone = document.getElementById("phone").value;
        const selectedBarber = document.getElementById("barber").value;
        const selectedDateButton = document.querySelector(
          "#date button.selected"
        );
        const selectedTime = document.querySelector("#time button.selected");
        const selectedStyle = document.getElementById("style").value;

        if (
          !name &&
          !email &&
          !phone &&
          !selectedBarber &&
          !selectedStyle &&
          !selectedDateButton &&
          !selectedTime
        ) {
          displayAlert(
            "warning",
            "Por favor, preencha todos os campos obrigatórios."
          );
          hideLoading(); // Oculta o loader em caso de campos não preenchidos
          return;
        }

        if (!name) {
          displayAlert("warning", "Por favor, digite um nome.");
          hideLoading();
          return;
        }

        if (!email) {
          displayAlert("warning", "Por favor, digite um email.");
          hideLoading();
          return;
        }

        if (!phone) {
          displayAlert("warning", "Por favor, digite um numero de telefone.");
          hideLoading();
          return;
        }

        if (!selectedBarber) {
          displayAlert("warning", "Por favor, escolha um barbeiro.");
          hideLoading();
          return;
        }

        if (!selectedStyle) {
          displayAlert("warning", "Por favor, escolha um estilo de corte.");
          hideLoading();
          return;
        }

        if (!selectedDateButton) {
          displayAlert("warning", "Por favor, selecione um dia.");
          hideLoading();
          return;
        }

        if (!selectedTime) {
          displayAlert("warning", "Por favor, selecione um horário.");
          hideLoading();
          return;
        }

        const selectedDate = new Date(
          selectedDateButton.getAttribute("data-date")
        );

        const selectedTimeValue = selectedTime.getAttribute("data-time");
        const [entry, exit] = selectedTimeValue.split("-");
        const entryDate = new Date(selectedDate);
        entryDate.setUTCHours(
          Number(entry.split(":")[0]),
          Number(entry.split(":")[1]),
          0,
          0,
          0
        );
        const exitDate = new Date(selectedDate);
        exitDate.setUTCHours(
          Number(exit.split(":")[0]),
          Number(exit.split(":")[1]),
          0,
          0,
          0
        );
        const dateTimeStart = entryDate.toISOString();
        const dateTimeEnd = exitDate.toISOString();

        try {
          const response = await fetch(
            "https://google-agenda.onrender.com/createAppointment",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                clientId,
                clientMailStore,
                selectedBarber,
                clientName: name,
                clientEmail: email,
                clientPhone: phone,
                calendarId,
                barberColorId: mapBarberToColor(selectedBarber),
                dateTimeStart: dateTimeStart, // Já está em UTC+0
                dateTimeEnd: dateTimeEnd, // Já está em UTC+0
              }),
            }
          );

          if (response.ok) {
            const styleLabel =
              selectedStyle === "normal"
                ? "Corte Normal (30min)"
                : selectedStyle === "barba"
                ? "Corte + Barba (1h)"
                : selectedStyle === "pintura"
                ? "pintura (2h)"
                : "";
            const formattedDate = formatDateUserFriendly(
              new Date(exitDate.getTime())
            );
            const successMessage = `Compromisso criado com sucesso!\n\nNome: ${name}\nE-mail: ${email}\nTelefone: ${phone}\nBarbeiro: ${selectedBarber}\nEstilo: ${styleLabel}\nData: ${formattedDate}\nHorário: ${selectedTimeValue}`;
            openModal(successMessage);
          } else {
            displayAlert(
              "error",
              "O barbeiro não está disponível neste horário."
            );
          }
        } catch (error) {
          console.error("Erro ao enviar a solicitação:", error);
          displayAlert("error", "Erro ao enviar a solicitação.");
        } finally {
          hideLoading(); // Oculta o loader após a resposta do servidor
        }
      };
      /*  */

      document.getElementById("barber").onchange = function () {
        const dateButtons = document.querySelectorAll("#date button");
        const timeButtons = document.querySelectorAll("#time button");
        dateButtons.forEach((button) => button.classList.remove("selected"));
        timeButtons.forEach((button) => button.classList.remove("selected"));
        document.getElementById("style").value = "";
      };

      document.getElementById("style").onchange = function () {
        const dateButtons = document.querySelectorAll("#date button");
        const timeButtons = document.querySelectorAll("#time button");
        dateButtons.forEach((button) => button.classList.remove("selected"));
        timeButtons.forEach((button) => button.classList.remove("selected"));
      };

      // Adicione uma função para verificar se os campos obrigatórios estão preenchidos
      function areFieldsFilled() {
        const name = document.getElementById("name").value;
        const email = document.getElementById("email").value;
        const phone = document.getElementById("phone").value;
        const selectedBarber = document.getElementById("barber").value;
        const selectedStyle = document.getElementById("style").value;

        return name && email && phone && selectedBarber && selectedStyle;
      }

      // Modifique a função que lida com o clique nos botões de data
      document.getElementById("date").onclick = function (event) {
        if (event.target.tagName === "BUTTON") {
          // Verifica se todos os campos obrigatórios estão preenchidos
          if (!areFieldsFilled()) {
            displayAlert(
              "warning",
              "Por favor, preencha todos os campos obrigatórios."
            );
            return;
          }

          const selectedDate = new Date(event.target.getAttribute("data-date"));
          const startTime = selectedDate.toISOString();
          const endTime = new Date(
            selectedDate.getTime() + 24 * 60 * 60 * 1000
          ).toISOString(); // Adiciona um dia
          const selectedStyle = document.getElementById("style").value;
          let timeType;

          if (selectedStyle === "barba") {
            timeType = "oneTimes";
          } else if (selectedStyle === "normal") {
            timeType = "halfTimes";
          } else if (selectedStyle === "pintura") {
            timeType = "twoTimes";
          }

          // Verifica se o formulário de exclusão está sendo usado
          const isDeleteForm = document
            .querySelector(".delete-appointment")
            .contains(event.target);

          // Se não for o formulário de exclusão, chama a função checkAvailabilityAndUpdateInterface
          if (!isDeleteForm) {
            checkAvailabilityAndUpdateInterface(startTime, endTime, timeType);
          }
        }
      };

      function updateOccupiedTimes(occupiedTimes) {
        const timeButtons = document.querySelectorAll("#time button");
        const selectedBarberColor = mapBarberToColor(
          document.getElementById("barber").value
        );

        timeButtons.forEach((button) => {
          const time = button.getAttribute("data-time");
          if (
            occupiedTimes[time] === false ||
            occupiedTimes[time] === selectedBarberColor ||
            selectedBarberColor === "1"
          ) {
            button.classList.add("occupied");
          } else {
            button.classList.remove("occupied");
          }
        });
      }

      function openModal(message) {
        const modalMessage = document.getElementById("modalMessage");
        const lines = message.split("\n");
        modalMessage.innerHTML = `<h2>${lines[0]}</h2>`;
        for (let i = 1; i < lines.length; i++) {
          const indexOfColon = lines[i].indexOf(":");
          if (indexOfColon !== -1) {
            const label = lines[i].substring(0, indexOfColon + 1);
            let value = lines[i].substring(indexOfColon + 1).trim();

            // Adiciona espaçamento antes de "Nome:", "Telefone:", etc.
            if (
              label === "Nome:" ||
              label === "Telefone:" ||
              label === "E-mail:"
            ) {
              value = `<span style="margin-right: 5px;">${value}</span>`;
            }

            modalMessage.innerHTML += `<p><strong>${label}</strong> ${value}</p>`;
          } else {
            modalMessage.innerHTML += `<p>${lines[i]}</p>`;
          }
        }
        document.getElementById("successModal").style.display = "block";
      }

      function closeModal() {
        document.getElementById("successModal").style.display = "none";
        location.reload();
      }

      function displayAlert(type, message) {
        const notificationContainer = document.getElementById(
          "notification-container"
        );

        if (!notificationContainer) {
          console.error("Elemento #notification-container não encontrado.");
          return;
        }

        // Criar o elemento da notificação
        const notification = document.createElement("li");
        notification.className = `notification-item ${type}`;

        // Definir o HTML da notificação
        notification.innerHTML = `
    <div class="notification-content">
        <div class="notification-icon">
            ${getNotificationIcon(type)}
        </div>
        <div class="notification-text">${message}</div>
    </div>
    <div class="notification-icon notification-close">
        <svg aria-hidden="true" fill="none" viewBox="0 0 24 24">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18 17.94 6M18 18 6.06 6"></path>
        </svg>
    </div>
    <div class="notification-progress-bar"></div>
  `;

        // Adiciona a notificação ao container
        notificationContainer.appendChild(notification);

        // Apenas o último aviso adicionado deve ser visível com display: flex
        setTimeout(() => {
          notification.style.display = "flex";
        }, 0); // Adicionar com delay para aplicar a mudança do display

        // Remove a notificação após um tempo
        setTimeout(() => {
          notification.remove();
        }, 5000);

        // Permite fechar manualmente
        notification.querySelector(".notification-close").onclick = () =>
          notification.remove();
      }

      // Função para retornar o SVG correto baseado no tipo de notificação
      function getNotificationIcon(type) {
        const icons = {
          success: `
            <svg aria-hidden="true" fill="none" viewBox="0 0 24 24">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.5 11.5 11 14l4-4m6 2a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"></path>
            </svg>
        `,
          warning: `
            <svg aria-hidden="true" fill="none" viewBox="0 0 24 24">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 13V8m0 8h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"></path>
            </svg>
        `,
          error: `
            <svg aria-hidden="true" fill="none" viewBox="0 0 24 24">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m15 9-6 6m0-6 6 6m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"></path>
            </svg>
        `,
        };
        return icons[type] || "";
      }
    </script>
  </body>
</html>
